<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.abdecd.novelbackend.business.mapper.ReaderHistoryMapper">
    <select id="listReaderHistoryVO"
            resultType="com.abdecd.novelbackend.business.pojo.vo.reader.ReaderHistoryVO">
        SELECT rh.id, rh.novel_id, rh.volume_number, rh.chapter_number, rh.timestamp
               ni.title as novelTitle, ni.author, ni.cover,
               nc.title as chapterTitle
        FROM reader_history rh
        LEFT JOIN novel_info ni ON rh.novel_id = ni.id
        LEFT JOIN novel_chapter nc ON rh.novel_id = nc.novel_id AND rh.volume_number = nc.volume_number AND rh.chapter_number = nc.chapter_number
        <where>
            <if test="userId != null">
                and rh.user_id = #{userId}
            </if>
            <if test="startId != null">
                and rh.id &lt;= #{startId}
            </if>
            and status = #{enableStatus}
        </where>
        limit #{pageSize}
    </select>
    <select id="getRankList" resultType="com.abdecd.novelbackend.business.pojo.entity.NovelInfo">
        SELECT ni.id, ni.title, ni.author, ni.cover, ni.description
        from (
            SELECT rh.novel_id, COUNT(1) as count
            FROM reader_history rh
            WHERE rh.timestamp &gt;= #{startTime} and rh.timestamp &lt; #{endTime}
            GROUP BY rh.novel_id
            ORDER BY count DESC
            limit 100
        ) as t1
        LEFT JOIN novel_info ni ON t1.novel_id = ni.id
    </select>
    <select id="getRankListByTagName" resultType="com.abdecd.novelbackend.business.pojo.entity.NovelInfo">
        WITH novels AS (
            SELECT nat.novel_id
            FROM novel_tags nt
                 JOIN novel_and_tags nat ON nt.id = nat.tag_id
            WHERE nt.tag_name = #{tagName}
        )
        SELECT ni.id, ni.title, ni.author, ni.cover, ni.description
        FROM (
             SELECT rh.novel_id, COUNT(1) as count
             FROM novels
                 JOIN reader_history rh ON novels.novel_id = rh.novel_id
             WHERE rh.timestamp &gt;= #{startTime} and rh.timestamp &lt; #{endTime}
             GROUP BY rh.novel_id
             ORDER BY count DESC
             limit 100
         ) as t1
         LEFT JOIN novel_info ni ON t1.novel_id = ni.id
    </select>
</mapper>